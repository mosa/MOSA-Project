name: Builds

on:
  push:
  pull_request:

jobs:

  windows-build:
    name: Windows Build
    runs-on: windows-latest
    env:
      BUILD_VERSION: 2.4.0
      NUGET_ENABLE_LEGACY_CSPROJ_PACK: true
    steps:
      - name: Set net7.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'
      - name: View Build Version
        run: echo ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: View Github Info
        run: echo repository=${{ github.repository }} event_name=${{ github.event_name }} ref=${{ github.ref }} head_ref=${{ github.head_ref }} base_ref=${{ github.base_ref }}
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1
      - name: Setup Nuget.exe
        uses: nuget/setup-nuget@v1
      - name: Restore nuget Packages
        run: dotnet restore Source/Mosa.sln
      - name: Build
        run: dotnet build Source/Mosa.sln /p:Version=${{ env.BUILD_VERSION }}
      - name: Store Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Build Project - Mosa.Templates
        run: dotnet build Source\Mosa.Templates\Mosa.Templates.csproj
      - name: Create Package - Mosa.Templates
        run: nuget pack Source\Mosa.Templates\Mosa.Templates.csproj -Tool -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Tools.Package
        run: nuget pack Source\Mosa.Packages\Mosa.Tools.Package.nuspec -Tool -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Korlib
        run: nuget pack Source\Mosa.Packages\Mosa.Korlib.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.DeviceSystem
        run: nuget pack Source\Mosa.Packages\Mosa.DeviceSystem.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Runtime
        run: nuget pack Source\Mosa.Packages\Mosa.Runtime.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Platform.x86
        run: nuget pack Source\Mosa.Packages\Mosa.Platform.x86.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Kernel.x86
        run: nuget pack Source\Mosa.Packages\Mosa.Kernel.x86.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Platform.x64
        run: nuget pack Source\Mosa.Packages\Mosa.Platform.x64.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Package - Mosa.Kernel.x64
        run: nuget pack Source\Mosa.Packages\Mosa.Kernel.x64.nuspec -OutputDirectory bin\nupkg -Version ${{ env.BUILD_VERSION }}.${{ github.run_number }}
      - name: Create Nuget Packages Artifact
        uses: actions/upload-artifact@master
        with:
          name: Nuget Packages
          path: bin\nupkg

  linux-build:
    name: Linux Build
    runs-on: ubuntu-latest
    steps:
      - name: Set net7.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Restore nuget Packages
        run: dotnet restore Source/Mosa.Linux.sln
      - name: Build
        run: dotnet build Source/Mosa.Linux.sln
      - name: Store Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
          
  generate-docs:
    name: Generate documentation
    runs-on: ubuntu-latest
    steps:
      - name: Set python3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Update package respository
        run: sudo apt-get -y -o Acquire::Check-Valid-Until=false update
      - name: Install Graphviz
        run: sudo apt-get install -y graphviz
      - name: Install Sphinx dependencies
        run: pip3 install sphinx sphinxcontrib.httpdomain sphinx-prompt sphinx_rtd_theme sphinx-tabs
      - name: Generate HTML website
        run: sphinx-build -b html Source/Docs sphinx-docs
      - name: Create ZIP archive
        run: zip -r docs-${{ env.BUILD_VERSION }}.${{ github.run_number }}.zip sphinx-docs
      - name: Create artifact
        uses: actions/upload-artifact@master
        with:
          name: docs-${{ env.BUILD_VERSION }}.${{ github.run_number }}.zip
          path: docs-${{ env.BUILD_VERSION }}.${{ github.run_number }}.zip

  windows-unit-testing-oMax:
    name: Windows - Unit Testing -oMax
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -oMax -display-off

  windows-unit-testing-oNone:
    name: Windows - Unit Testing -oNone
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -oNone -display-off

  windows-unit-testing-o1:
    name: Windows - Unit Testing -o1
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o1 -display-off

  windows-unit-testing-o2:
    name: Windows - Unit Testing -o2
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o2 -display-off

  windows-unit-testing-o3:
    name: Windows - Unit Testing -o3
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o3 -display-off

  windows-unit-testing-o4:
    name: Windows - Unit Testing -o4
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o4 -display-off

  windows-unit-testing-o5:
    name: Windows - Unit Testing -o5
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o5 -display-off

  windows-unit-testing-o6:
    name: Windows - Unit Testing -o6
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o6 -display-off

  windows-unit-testing-o7:
    name: Windows - Unit Testing -o7
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o7 -display-off

  windows-unit-testing-o8:
    name: Windows - Unit Testing -o8
    runs-on: windows-latest
    needs: windows-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: windows-build-artifact
          path: bin
      - name: Unit Testing
        run: bin\Mosa.Utility.UnitTests.exe -o8 -display-off

  linux-unit-testing-oMax:
    name: Linux - Unit Testing -oMax
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -oMax -display-off

  linux-unit-testing-oNone:
    name: Linux - Unit Testing -oNone
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -oNone -display-off

  linux-unit-testing-o1:
    name: Linux - Unit Testing -o1
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o1 -display-off

  linux-unit-testing-o2:
    name: Linux - Unit Testing -o2
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o2 -display-off

  linux-unit-testing-o3:
    name: Linux - Unit Testing -o3
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o3 -display-off

  linux-unit-testing-o4:
    name: Linux - Unit Testing -o4
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o4 -display-off

  linux-unit-testing-o5:
    name: Linux - Unit Testing -o5
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o5 -display-off

  linux-unit-testing-o6:
    name: Linux - Unit Testing -o6
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o6 -display-off

  linux-unit-testing-o7:
    name: Linux - Unit Testing -o7
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o7 -display-off

  linux-unit-testing-o8:
    name: Linux - Unit Testing -o8
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: linux-build-artifact
          path: bin
      - name: Unit Testing
        run: dotnet bin/Mosa.Utility.UnitTests.exe -o8 -display-off
