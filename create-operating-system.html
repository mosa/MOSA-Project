<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create your own operating system &mdash; MOSA Project  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/sphinx_prompt_css.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MOSA Project Structure" href="mosa-project-structure.html" />
    <link rel="prev" title="Demos" href="demos.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            MOSA Project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions (FAQs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="demos.html">Demos</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Create your own operating system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#theory">Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Structure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="mosa-project-structure.html">MOSA Project Structure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Compiler</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="compiler-design.html">Compiler Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler-optimizations.html">Compiler Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler-transformations.html">Compiler Transformations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Settings</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="optimization-options.html">Optimization Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings-options.html">Settings Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="command-line-arguments.html">Command Line Arguments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tool-compiler.html">MOSA Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool-launcher.html">MOSA Launcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool-launcher-console.html">MOSA Launcher Console</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool-explorer.html">MOSA Explorer</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool-debugger.html">MOSA Debugger</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="unit-tests.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="usb-flash-drive-installation.html">USB Flash Drive Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="baremetal.html">BareMetal Experiment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="runtime-tables.html">MOSA Runtime Tables</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribute</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="get-involved.html">Get Involved</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MOSA Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Create your own operating system</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/create-operating-system.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="create-your-own-operating-system">
<h1>Create your own operating system<a class="headerlink" href="#create-your-own-operating-system" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>Now that you’ve learned to either launch a pre-existing demo project or make your own, we’ll teach you the basics of the MOSA framework, and how to make your OS more interesting! Let’s get started!</p>
</section>
<section id="theory">
<h2>Theory<a class="headerlink" href="#theory" title="Permalink to this heading"></a></h2>
<p>But first, a bit of theory (or how the MOSA framework works). The idea around MOSA is modularity, and it is its sort of key selling point. You can either use all of it, part of it, or close to none at all (at least the Mosa.Runtime.* projects are required for the architecture you want to compile for). It thus means that getting started is quite more difficult than one might think. But it’s also not that difficult!</p>
<p>Let’s take the example of device drivers. Typically, a device driver might want to talk to the rest of the system (for example, it might want to print to the standard output/console, write to an I/O port, etc…). To be able to do this, it uses the OS’ <strong>Hardware Abstraction Layer</strong>. Essentially, it’s an interface which lets parts of the OS communicate with each other.</p>
<p>The HAL needs to be implemented in some way. In MOSA, it is implemented by the end user, for modularity reasons. It inherits the <code class="docutils literal notranslate"><span class="pre">BaseHardwareAbstraction</span></code> class which provides a couple of methods commonly used by device drivers, and other code (it doesn’t have to be used just by the device drivers!).</p>
<p>Now that we’ve seen how device drivers typically work, let’s look more about how the MOSA framework specifically works. In a typical MOSA project, you’ll see the following structure:</p>
<p><strong>Architecture-specific kernel initialization code</strong>
- This would typically be a call to <code class="docutils literal notranslate"><span class="pre">Mosa.Kernel.*Architecture*.Setup()</span></code>, but can also be other stuff (for example, <code class="docutils literal notranslate"><span class="pre">Mosa.Kernel.x86.IDT.SetInterruptHandler()</span></code>).</p>
<p><strong>Initialize system services</strong>
- The most useful one is the <code class="docutils literal notranslate"><span class="pre">DeviceService</span></code> which allows one to get either all devices via their respective device driver, or to get a specific device. But you also have important ones, like the PCI services for controlling PCI devices, and the <code class="docutils literal notranslate"><span class="pre">PCService</span></code> for shutting down and rebooting the system, amongst others.</p>
<p><strong>Initialize the HAL</strong>
- While we might have created the class, we certainly haven’t used it. This part would let the device drivers framework know about the HAL we’ve made.</p>
<p><strong>Initialize device drivers</strong>
- This is pretty self-explanatory: it initializes all the device drivers which exist on the system. However, if we want to, we can omit certain device drivers, since the method to register all device drivers simply takes in a list of device driver entries.</p>
<p><strong>Initialize specific services</strong>
- For example, you could initialize the <code class="docutils literal notranslate"><span class="pre">PartitionService</span></code>, yet another service which allows you to work with all the partitions on the system.</p>
<p><strong>Your code!</strong>
- At this point, we’ve finished initializing everything MOSA needs, and we’re ready to go. We’ll look at how we initialize all of this below.</p>
<p>All of this might seem a bit daunting at first, however, once you have all the initialization code in place, you don’t have to touch it anymore! With that being said, let’s look at how we initialize all of this:</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading"></a></h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This guide will assume you’re compiling for the <strong>x86</strong> architecture.</p>
</div>
<p><strong>Architecture-specific kernel initialization code</strong></p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">Mosa</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">x86</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">Setup</span><span class="p">();</span>
</pre></div>
</div>
<p>And we’re done! Well, almost… you see, on x86, we need to initialize what’s called the IDT, which is for system interrupts. This guide won’t cover it, but you can find information about it online.</p>
<p>Create a method like so in your code:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ProcessInterrupt</span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="n">interrupt</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="n">errorCode</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">interrupt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0</span><span class="n">x20</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="n">x30</span><span class="p">)</span>
<span class="w">                </span><span class="n">DeviceSystem</span><span class="p">.</span><span class="n">HAL</span><span class="p">.</span><span class="n">ProcessInterrupt</span><span class="p">((</span><span class="kt">byte</span><span class="p">)(</span><span class="n">interrupt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0</span><span class="n">x20</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This method will process any incoming system interrupt for a device. Next, right after your <code class="docutils literal notranslate"><span class="pre">Setup()</span></code> call, add this one:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">Mosa</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">x86</span><span class="p">.</span><span class="n">IDT</span><span class="p">.</span><span class="n">SetInterruptHandler</span><span class="p">(</span><span class="n">ProcessInterrupt</span><span class="p">);</span>
</pre></div>
</div>
<p>And now, we’re done for real this time!</p>
<p><strong>Initialize system services</strong></p>
<p>Let’s first start by creating a <code class="docutils literal notranslate"><span class="pre">ServiceManager</span></code>:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span><span class="w"> </span><span class="n">serviceManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceManager</span><span class="p">();</span>
</pre></div>
</div>
<p>The service manager will take care of initializing all services for us. Next, we can create and add some service to it:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span><span class="w"> </span><span class="n">deviceService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DeviceService</span><span class="p">();</span>
<span class="kt">var</span><span class="w"> </span><span class="n">pciControllerService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PCIControllerService</span><span class="p">();</span>
<span class="kt">var</span><span class="w"> </span><span class="n">pciDeviceService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PCIDeviceService</span><span class="p">();</span>

<span class="n">serviceManager</span><span class="p">.</span><span class="n">AddService</span><span class="p">(</span><span class="n">deviceService</span><span class="p">);</span>
<span class="n">serviceManager</span><span class="p">.</span><span class="n">AddService</span><span class="p">(</span><span class="n">pciControllerService</span><span class="p">);</span>
<span class="n">serviceManager</span><span class="p">.</span><span class="n">AddService</span><span class="p">(</span><span class="n">pciDeviceService</span><span class="p">);</span>
</pre></div>
</div>
<p>To see the complete list of services, check out the <code class="docutils literal notranslate"><span class="pre">Mosa.DeviceSystem</span></code> project, and more specifically, the files under the <code class="docutils literal notranslate"><span class="pre">Service</span></code> folder.</p>
<p><strong>Initialize the HAL</strong></p>
<p>A single line of code will initialize the HAL:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span><span class="w"> </span><span class="n">hal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hardware</span><span class="p">();</span>
<span class="kt">var</span><span class="w"> </span><span class="n">processInterrupt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deviceService</span><span class="p">.</span><span class="n">ProcessInterrupt</span><span class="p">;</span>

<span class="n">Mosa</span><span class="p">.</span><span class="n">DeviceSystem</span><span class="p">.</span><span class="n">Setup</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">hal</span><span class="p">,</span><span class="w"> </span><span class="n">processInterrupt</span><span class="p">);</span>
</pre></div>
</div>
<p>If you’re wondering, the <code class="docutils literal notranslate"><span class="pre">Hardware</span></code> class is our implementation of the HAL. Unfortunately, it is a bit too in depth to cover here. Instead, you can find pre-existing implementations in the CoolWorld and SVGAWorld demos, each in the <code class="docutils literal notranslate"><span class="pre">HAL</span></code> folder. They don’t differ much, so knowing one will suffice.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">deviceService.ProcessInterrupt</span></code> method will process any interrupt for a specific device driver.</p>
<p><strong>Initialize device drivers</strong></p>
<p>To initialize device drivers, we first need to register them all, and then we can initialize them. You can do this like so:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">X86System</span><span class="p">();</span><span class="w"> </span><span class="c1">// This will depend on the architecture you wish to compile your OS for!</span>
<span class="kt">var</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mosa</span><span class="p">.</span><span class="n">DeviceDriver</span><span class="p">.</span><span class="n">Setup</span><span class="p">.</span><span class="n">GetDeviceDriverRegistryEntries</span><span class="p">();</span>

<span class="n">deviceService</span><span class="p">.</span><span class="n">RegisterDeviceDriver</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
<span class="n">deviceService</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">);</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">Mosa.DeviceDriver.Setup.GetDeviceDriverRegistryEntries()</span></code> is a method returning a List of all device drivers in MOSA. However, you can register your own list too, if you wish to do so! Check out the method’s implementation for more details.</p>
<p>If you’re asking yourself what the <code class="docutils literal notranslate"><span class="pre">null</span></code> is for here, it should be the <code class="docutils literal notranslate"><span class="pre">parent</span></code> argument. That is, the Device parent which will register the current device driver (because <code class="docutils literal notranslate"><span class="pre">X86System</span></code> is a device driver in MOSA!). However, because <code class="docutils literal notranslate"><span class="pre">X86System</span></code> here is actually the Device parent, we should set the parent argument to null (it doesn’t have any!).</p>
<p><strong>Initialize specific services</strong></p>
<p>Finally, you can initialize specific services here. For example, you could call the <code class="docutils literal notranslate"><span class="pre">CreatePartitionDevices</span></code> method of <code class="docutils literal notranslate"><span class="pre">PartitionService</span></code> in order to register all partitions on the system. The reason we’re doing this after initializing device drivers is because we need to initialize ATA (IDE), AHCI (SATA), or NVMe drivers for example.</p>
<p><strong>Your code!</strong></p>
<p>Well, we can’t write the code for you, but you get it now. After all these steps, you can finally build the OS you’ve always wanted to create!</p>
<p>If you have any more questions, don’t hesitate to ask on our <cite>Discord &lt;https://discord.gg/tRNMn3npsv&gt;</cite> server! We’ll happily answer them all :D</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demos.html" class="btn btn-neutral float-left" title="Demos" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mosa-project-structure.html" class="btn btn-neutral float-right" title="MOSA Project Structure" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2008-2022, Mosa Project &amp; contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>